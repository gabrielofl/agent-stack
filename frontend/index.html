<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiguru AD Intelligence</title>
  <link rel="stylesheet" href="./styles/app.css" />
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img class="logo" src="./assets/wiguru-logo.svg" alt="Wiguru" />
        <div>
          <div class="title">AD Intelligence Agent</div>
          <div class="subtitle">Powered by <span class="accent">Wiguru</span></div>
        </div>
      </div>

      <div class="top-actions">
		<div class="health-pills">
		<span id="pillBackend" class="pill pill-unk" title="Backend /health">Backend</span>
		<span id="pillAgent" class="pill pill-unk" title="Worker /health">Agent</span>
		<span id="pillLlm" class="pill pill-unk" title="Worker LLM health">LLM</span>
	  </div>

        <div class="dropdown">
          <button id="statusBtn" class="chip chip-btn" title="Status">
            <span id="dotStatus" class="dot warn"></span>
            <span>Status</span>
          </button>

          <div id="statusMenu" class="dropdown-menu" hidden>
            <div class="row"><span>HTTP</span><b id="httpLine">—</b></div>
            <div class="row"><span>WS</span><b id="wsLine">—</b></div>
            <div class="row"><span>Last frame</span><b id="frameLine">—</b></div>
            <div class="row"><span>FPS</span><b id="fpsLine">—</b></div>
            <div class="row"><span>Error</span><b id="errLine">—</b></div>
          </div>
        </div>

        <button id="adminBtn" class="chip chip-btn" title="Admin login / logout">
          <span id="adminBtnText">Login</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="grid">

      <!-- LEFT: Viewer + Agent follow-up BELOW screen -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            Live
            <span id="sessionDot" class="sess-dot off" title="Session"></span>
          </div>
        </div>

        <div class="screen-wrap">
          <div class="viewer-bar">
            <div class="pill">URL: <span class="mono" id="pageUrl">—</span></div>
            <div class="pill">Click: <span class="mono" id="clickText">—</span></div>
          </div>

          <div class="screen-layer">
            <img id="screen" class="screen" />
            <canvas id="overlay" class="overlay"></canvas>
          </div>
        </div>

        <!-- Agent follow-up section stays under screen (NO TAB) -->
        <div class="content agent-panel">
  <!-- Collapsed header row (always visible) -->
  <div class="agent-head" id="agentHead" role="button" tabindex="0" aria-expanded="false">
    <div class="agent-row" style="margin:0;">
      <div class="pill">Agent: <b id="agentState">—</b></div>
      <div class="pill">Step: <b id="agentStep">—</b></div>
      <div class="pill">Last: <b id="agentLast" class="mono">—</b></div>
    </div>

    <button class="btn ghost agent-toggle" id="agentToggleBtn" aria-label="Expand agent panel" title="Expand">
      <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
           xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Expanded content (hidden by default) -->
  <div class="agent-body" id="agentBody" hidden>
    <div class="agent-row">
      <button class="btn" id="btnApprove" disabled>Approve pending</button>
      <button class="btn ghost" id="btnAsk" disabled>Answer question…</button>
    </div>

    <div>
      <div class="card-subtitle" style="margin:0 0 8px 0;">Agent feed</div>
      <div id="agentFeed" class="log agent-feed"></div>
    </div>
  </div>
</div>

      </section>

      <!-- RIGHT: Panel (Tabs only USER / ADMIN) -->
      <aside class="card" id="sidePanel">
        <div class="card-header">
          <div class="card-title">
            Panel
            <span class="badge" id="metricsBadge">frames: 0 • bytes: 0</span>
          </div>

          <div class="actions tabs">
            <button class="btn ghost tab-btn active" id="tabUserBtn" data-tab="user">User</button>
            <button class="btn ghost tab-btn" id="tabAdminBtn" data-tab="admin" hidden>Admin</button>
          </div>
        </div>

        <div class="content" style="height:100%; min-height:0;">
          <!-- USER TAB -->
          <section id="tab-user" class="tab-pane chat-pane">
            <div>
              <div class="card-subtitle" style="margin-top:2px;">Chat</div>
            </div>

            <!-- Scrollable chat log -->
            <div id="userLog" class="log chat-log"></div>

            <!-- Suggested actions (feel like chat, not separate controls) -->
            <div class="quick-actions">
              <span class="chip qa" data-insert="/start https://example.com">start</span>
              <span class="chip qa" data-insert="/reconnect">reconnect</span>
              <span class="chip qa" data-insert="/stop">stop</span>
              <span class="chip qa" data-insert="/goto https://">goto</span>
              <span class="chip qa" data-insert="/type "> type</span>
            </div>

            <!-- Prominent typing area -->
            <div class="composer">
              <textarea
                id="chatInput"
              ></textarea>

              <!-- Voice placeholder: wire later -->
              <button class="btn ghost icon-btn" id="btnVoice" title="Voice" aria-label="Voice">
  <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
       xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3Z"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M19 11a7 7 0 0 1-14 0"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M12 18v3"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M8 21h8"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>


              <button class="btn primary" id="chatSend" aria-label="Send">
                Send
              </button>
            </div>

            <!-- LEGACY controls kept hidden so your current main.js doesn't break.
                 You can gradually migrate logic to chatInput parsing and remove these later. -->
            <div id="legacyControls" hidden>
              <input id="startUrl" value="https://example.com" />
              <button id="btnStart">Start session</button>

              <button id="btnReconnect">Reconnect</button>
              <button id="btnStop">Stop</button>

              <input id="typeText" placeholder="Text to type…" />
              <button id="btnType">Send</button>

              <input id="gotoUrl" placeholder="https://…" />
              <button id="btnGoto">Go</button>
            </div>
          </section>

          <!-- ADMIN TAB -->
          <section id="tab-admin" class="tab-pane" hidden>
            <div class="kv">
              <div><span>Origin</span><b id="originText"></b></div>
              <div><span>HTTP</span><b id="httpText"></b></div>
              <div><span>WS URL</span><b id="wsUrlText" class="mono"></b></div>
              <div><span>Session</span><b id="sessionIdText" class="mono"></b></div>
            </div>

            <div class="row" style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
              <button class="btn ghost" id="btnCopy">Copy</button>
              <button class="btn ghost" id="btnClear">Clear</button>
            </div>

            <div id="adminLog" class="log"></div>
          </section>
        </div>
      </aside>
    </section>
  </main>

  <!-- Login modal -->
  <div id="modalBackdrop" class="modal-backdrop" hidden>
    <div class="modal">
      <div class="modal-title">Login</div>
      <div class="modal-sub">Enter the password.</div>
      <div class="modal-field">
		<input
  id="adminPass"
  type="text"
  placeholder="Password"
  autocapitalize="off"
  spellcheck="false"
  class="mask-pass"
/>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn primary" id="modalLogin">Login</button>
      </div>
      <div class="modal-hint" id="modalHint"></div>
    </div>
  </div>

  <footer class="footer">
  <div class="footer-inner">© <strong>Wiguru</strong></div>
</footer>

  <!-- Tiny inline helper: chip inserts text into chat input (safe + optional) -->
  <script>
    (function () {
      function insertIntoChat(txt) {
        const el = document.getElementById('chatInput');
        if (!el) return;
        el.value = (el.value ? (el.value + ' ') : '') + txt;
        el.focus();
        el.setSelectionRange(el.value.length, el.value.length);
      }

      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;
        if (t.classList.contains('qa') && t.dataset.insert) insertIntoChat(t.dataset.insert);
      });
    })();
  </script>

  <script>
  (function () {
    const head = document.getElementById("agentHead");
    const body = document.getElementById("agentBody");
    const btn = document.getElementById("agentToggleBtn");
    if (!head || !body || !btn) return;

    function setExpanded(expanded) {
      body.hidden = !expanded;
      head.setAttribute("aria-expanded", String(expanded));
      btn.title = expanded ? "Collapse" : "Expand";
      btn.setAttribute("aria-label", expanded ? "Collapse agent panel" : "Expand agent panel");
      btn.style.transform = expanded ? "rotate(180deg)" : "rotate(0deg)";
      btn.style.transition = "transform 150ms ease";
    }

    // default collapsed
    setExpanded(false);

    head.addEventListener("click", (e) => {
      // If they click the button or pills, just toggle
      const expanded = head.getAttribute("aria-expanded") === "true";
      setExpanded(!expanded);
    });

    head.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const expanded = head.getAttribute("aria-expanded") === "true";
        setExpanded(!expanded);
      }
    });
  })();
</script>


  <!-- Your modular JS -->
  <script type="module" src="./js/main.js"></script>
</body>
</html>
